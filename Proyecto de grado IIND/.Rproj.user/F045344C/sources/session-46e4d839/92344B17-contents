#### RScript - Control de la Contaminacion #### 
# Author: Ricardo A. Silva
# Date: 11/09/2023
# R version 4.3.1
## ------------------------------------------ ## 

# Limpiar el entorno
rm(list = ls())

# Instalación de paquetes
#install.packages("pacman")
library(pacman)
p_load(tidyverse, lubridate, skimr, stargazer, dplyr, maps)


wd <- "C:/Users/windows/Documents/Andes/Semestre_10/Control de la contaminacion/Actividades/Lab 3"
setwd(wd)

carpeta <- "aqli_table_data_global_2021_who/"

list.files()
browseURL("https://aqli.epic.uchicago.edu/the-index/")
browseURL("https://github.com/aqli-epic/aqli-update/tree/main/data")


aqli <- read_csv("aqli_table_data_global_2021_who.csv")
aqli_global <- read_csv("aqli_global.csv")
aqli_jorge <- read_csv("Global_AQLI_ed.csv")
world_coordinates <- map_data("world")


# Transformaciones de caracteres y de variables
aqli_global$name[aqli_global$name=="United States"] = "USA"
aqli$name[aqli$name=="United States"] = "USA"
aqli$population <- as.numeric(aqli$population)

# Depuración de base de datos
aqli <- subset(aqli, pm2021 < 100)

# Ordenamiento
sort(aqli$population, decreasing = T)
order(aqli$population, decreasing = T)
rank(aqli$population)

aqli <- aqli %>% 
  mutate(pop_rank = rank(aqli$population)) %>% 
  mutate(pm_rank = rank(aqli$pm2021))

# Variable para EV
aqli_jorge <- read_csv("Global_AQLI_ed.csv")

aqli_jorge <- aqli_jorge %>% mutate(EV = round((pm2021 - 5)*0.098, 
                                               digits = 2))

aqli_jorge <- aqli_jorge %>% mutate(EV2 = ifelse(aqli_jorge$EV > 0,
                                                 aqli_jorge$EV, NA))
aqli_jorge <- aqli_jorge %>% mutate(Rank_EV2 = rank(aqli_jorge$EV2))


#=======#
# Mapas #
#=======#
browseURL("http://www.sthda.com/english/wiki/ggplot2-colors-how-to-change-colors-automatically-and-manually#change-colors-by-groups")

# Mapa World
ggplot() + 
  geom_map(data = world_coordinates, map = world_coordinates,
           aes(x=long, y=lat, map_id = region))

# Mapa World con Aqli
ggplot(aqli) +
  geom_map(data = world_coordinates, map = world_coordinates,
           aes(x=long, y=lat, map_id = region)) + 
  geom_map(map=world_coordinates, 
           aes(map_id=name, fill=pm2021), color="black")

# Mapa World con Aqli más bonito
ggplot(aqli_jorge) +
  geom_map(data = world_coordinates, map = world_coordinates,
           aes(map_id = region)) + 
  geom_map(map=world_coordinates, 
           aes(map_id=name, fill=pm2021), color="black") +
  expand_limits(x = world_coordinates$long, y = world_coordinates$lat) +
  labs(title = "Mapa de Material Particulado 2.5 Mundial",
       subtitle = "Año 2021",
       x = "Longitud",
       y = "Latitud",
       caption = "Datos de AQLI Chicago")

# Mapa World con Aqli más bonito y con colores
ggplot(aqli_jorge) +
  geom_map(data = world_coordinates, map = world_coordinates,
           aes(map_id = region)) + 
  geom_map(map=world_coordinates, 
           aes(map_id=name, fill=pm2021), color="black") +
  expand_limits(x = world_coordinates$long, y = world_coordinates$lat) +
  labs(title = "Mapa de Material Particulado 2.5 Mundial",
       subtitle = "Año 2021",
       x = "Longitud",
       y = "Latitud",
       caption = "Datos de AQLI Chicago") + 
  scale_fill_continuous(type = "viridis")
#ggsave("pm25.png", plot = last_plot())
